<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MindBound – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body class="page-transition">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<!-- SUBNAV MINDBOUND -->
<nav class="subnav">
  <ul>
    <li><a href="../mindbound/mindbound.html">Home Team</a></li>
    <li><a href="../mindbound/roster-mindbound.html">Roster</a></li>
    <li><a href="../mindbound/mindbound-news.html">News</a></li>
    <li><a href="../mindbound/mindbound-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<!-- HERO COME LE ALTRE PAGINE -->
<section class="hero">
  <div class="hero-content">
    <h2>MindBound – Progress raid</h2>
    <p>
      Stato aggiornato del team MindBound: avanzamento per difficolt&agrave;, ultimi boss affrontati e report dell’ultima sessione.
    </p>
  </div>
</section>

<!-- SFONDO CON LOGO MINDBOUND -->
<div class="bg-container bg-mindbound-logo">
  <main class="panel">

    <!-- PANORAMICA PER DIFFICOLTÀ -->
    <h2 class="section-title">Panoramica per difficolt&agrave;</h2>
    <p class="section-subtitle">
      Stato del raid per Normal, Heroic e Mythic: quanti boss sono stati sconfitti,
      quali sono ancora in progress e qual &egrave; stato il miglior pull.
    </p>

    <div class="widgets-grid">
      <!-- NORMAL -->
      <div class="widget-card">
        <h3 class="widget-title">Normal</h3>
        <p class="widget-desc">Progress del team in difficolt&agrave; Normal.</p>
        <div class="progress-content" id="card-normal">
          Caricamento...
        </div>
      </div>

      <!-- HEROIC -->
      <div class="widget-card">
        <h3 class="widget-title">Heroic</h3>
        <p class="widget-desc">Stato dell'avanzamento in Heroic.</p>
        <div class="progress-content" id="card-heroic">
          Caricamento...
        </div>
      </div>

      <!-- MYTHIC -->
      <div class="widget-card">
        <h3 class="widget-title">Mythic</h3>
        <p class="widget-desc">La punta del progress del team, in Mythic.</p>
        <div class="progress-content" id="card-mythic">
          Caricamento...
        </div>
      </div>
    </div>

    <!-- ULTIMA SESSIONE – TIMELINE -->
    <div class="widget-full">
      <h2 class="section-title" id="last-session-title">Ultima sessione raid</h2>
      <p class="section-subtitle">
        Resoconto completo dei boss affrontati nell’ultima serata MindBound:
        pull, kill, progress e migliori percentuali.
      </p>

      <div class="session-summary-card" id="last-session-summary">
        Caricamento dati dell'ultima sessione...
      </div>

      <div class="timeline-container" id="last-session-timeline">
        <!-- Card dei boss generate via JS -->
      </div>
    </div>

    <!-- LINK LOGS GENERALE -->
    <div class="widget-full" style="margin-top: 40px;">
      <h2 class="section-title">Warcraft Logs</h2>
      <p class="section-subtitle">
        Per analisi dettagliate dell’ultima serata MindBound puoi aprire direttamente
        il report completo su Warcraft Logs.
      </p>
      <div style="text-align:center; margin-top: 15px;">
        <a
          id="last-session-report-link"
          href="#"
          target="_blank"
          class="apply-button"
          style="display:none;"
        >
          Apri il report dell’ultima sessione
        </a>
      </div>
    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Delirium Tremens</p>
</footer>

<!-- TRANSIZIONE PAGINE -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("page-loaded");
});

document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- URL WORKERS (MindBound) -->
<script>
  const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
  const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";
</script>

<!-- LOGICA PROGRESS (CARD + ULTIMA SESSIONE TIMELINE) -->
<script>
async function loadDifficulty(diff, elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;

  try {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();

    const bosses = Object.keys(data.bosses || {});
    const total = bosses.length;

    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const inProgress = bosses.filter(
      b =>
        data.bosses[b].kills === 0 &&
        data.bosses[b].bestPercentage !== null &&
        data.bosses[b].bestPercentage < 100
    );

    let html = `
      <div class="progress-line"><strong>Boss sconfitti:</strong> ${killed.length} / ${total}</div>
      <div class="progress-line"><strong>Boss in progress:</strong> ${inProgress.length}</div>
    `;

    const bestPulls = inProgress.map(b => data.bosses[b].bestPercentage);
    const bestOverall = bestPulls.length > 0 ? Math.min(...bestPulls) : null;
    html += `<div class="progress-line"><strong>Miglior pull:</strong> ${
      bestOverall !== null ? bestOverall + "%" : "–"
    }</div>`;

    html += `<div class="boss-list">`;
    killed.forEach(b => {
      html += `<span class="boss-killed">${b}</span>`;
    });
    inProgress.forEach(b => {
      html += `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`;
    });
    html += `</div>`;

    el.innerHTML = html;
  } catch (err) {
    console.error("Errore caricamento progress", diff, err);
    el.textContent = "Errore nel caricamento dei dati.";
  }
}

async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

function formatDuration(ms) {
  if (!ms || ms <= 0) return "N/D";
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  return `${h > 0 ? h + "h " : ""}${m}m`;
}

function renderLastSessionTimeline(last) {
  const timeline = document.getElementById("last-session-timeline");
  const summary = document.getElementById("last-session-summary");

  const bosses = Object.values(last.bosses || {});
  if (bosses.length === 0) {
    summary.innerHTML = "Nessun dato trovato per l'ultimo raid.";
    timeline.innerHTML = "";
    return;
  }

  const diffs = new Set();
  bosses.forEach(b => b.difficultiesSeen?.forEach(d => diffs.add(d)));

  const diffName =
    diffs.has(5) ? "Mythic" :
    diffs.has(4) ? "Heroic" :
    diffs.has(3) ? "Normal" :
    "N/A";

  const titleEl = document.getElementById("last-session-title");
  titleEl.textContent = `Ultima sessione raid (${diffName})`;

  const linkEl = document.getElementById("last-session-report-link");
  if (linkEl && last.latestReport && last.latestReport.code) {
    linkEl.href = `https://www.warcraftlogs.com/reports/${last.latestReport.code}`;
    linkEl.style.display = "inline-block";
  }

  const pullsTotal = bosses.reduce((sum, b) => sum + b.pulls, 0);
  const wipesTotal = bosses.reduce((sum, b) => sum + b.wipes, 0);
  const killsTotal = bosses.reduce((sum, b) => sum + b.kills, 0);

  const sessionStart = last.latestReport?.startTime || null;
  const sessionEnd   = last.latestReport?.endTime || null;
  const durationMs   = (sessionStart && sessionEnd) ? (sessionEnd - sessionStart) : null;

  summary.innerHTML = `
    <strong>Boss affrontati:</strong> ${bosses.length}<br>
    <strong>Pull totali:</strong> ${pullsTotal}<br>
    <strong>Wipe totali:</strong> ${wipesTotal}<br>
    <strong>Kill totali:</strong> ${killsTotal}<br>
    <strong>Durata sessione:</strong> ${formatDuration(durationMs)}
  `;

  bosses.sort((a, b) => a.bossName.localeCompare(b.bossName));
  timeline.innerHTML = "";

  bosses.forEach(b => {
    const isKill = b.kills > 0;
    const bestPct = b.bestPercentage ?? "—";

    const card = document.createElement("div");
    card.className = "timeline-card " + (isKill ? "kill" : "progress");

    card.innerHTML = `
      <div class="timeline-title">${b.bossName}</div>
      <div class="timeline-info"><strong>Esito:</strong> ${isKill ? "Kill ✔️" : "Progress"}</div>
      <div class="timeline-info"><strong>Pulls:</strong> ${b.pulls}</div>
      <div class="timeline-info"><strong>Wipes:</strong> ${b.wipes}</div>
      <div class="timeline-info"><strong>Best %:</strong> ${bestPct !== "—" ? bestPct + "%" : "—"}</div>
    `;

    timeline.appendChild(card);
  });
}

(async () => {
  loadDifficulty("normal", "card-normal");
  loadDifficulty("heroic", "card-heroic");
  loadDifficulty("mythic", "card-mythic");

  try {
    const last = await fetchLastSession();
    console.log("Last session (MindBound):", last);
    renderLastSessionTimeline(last);
  } catch (err) {
    console.error("Errore nel caricamento dell'ultima sessione", err);
    const summary = document.getElementById("last-session-summary");
    summary.innerHTML = "Errore nel caricamento dell'ultima sessione.";
  }
})();
</script>

</body>
</html>
