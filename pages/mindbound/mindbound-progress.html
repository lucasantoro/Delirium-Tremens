<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MindBound – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body class="page-transition">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="../mindbound/mindbound.html">Home Team</a></li>
    <li><a href="../mindbound/roster-mindbound.html">Roster</a></li>
    <li><a href="../mindbound/mindbound-news.html">News</a></li>
    <li><a href="../mindbound/mindbound-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<div class="bg-container bg-mindbound-logo">
  <main class="panel">

    <!-- ============================== -->
    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Stato del raid in Normal, Heroic e Mythic.
    </p>

    <div class="widgets-grid">
      <div class="widget-card"><h3 class="widget-title">Normal</h3><p class="widget-desc">Avanzamento in Normal</p><div id="card-normal" class="progress-content">Caricamento...</div></div>
      <div class="widget-card"><h3 class="widget-title">Heroic</h3><p class="widget-desc">Avanzamento in Heroic</p><div id="card-heroic" class="progress-content">Caricamento...</div></div>
      <div class="widget-card"><h3 class="widget-title">Mythic</h3><p class="widget-desc">Avanzamento in Mythic</p><div id="card-mythic" class="progress-content">Caricamento...</div></div>
    </div>

    <!-- ============================== -->
    <section class="widget-full" style="margin-top:40px;">
      <h2 class="section-title">Live del Raid</h2>
      <p class="section-subtitle">Guarda la diretta del team MindBound o vedi gli ultimi VOD.</p>
      <div id="twitch-live-container" style="text-align:center;"></div>
    </section>

    <!-- ============================== -->
    <h2 class="section-title" id="last-session-title">Ultima sessione</h2>
    <p class="section-subtitle">Riassunto compatto dei boss affrontati.</p>

    <div id="last-session-summary" class="session-summary-card">Caricamento...</div>

    <div class="pill-timeline" id="pill-timeline"></div>

    <div class="widget-full" style="text-align:center; margin-top:25px;">
      <a id="last-session-report-link" class="apply-button" style="display:none;" target="_blank">
        Apri il report completo
      </a>
    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Delirium Tremens</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => document.body.classList.add("page-loaded"));

document.querySelectorAll("a").forEach(a => {
  if (a.hostname === location.hostname) {
    a.addEventListener("click", e => {
      e.preventDefault();
      document.body.classList.remove("page-loaded");
      setTimeout(() => location.href = a.href, 250);
    });
  }
});
</script>

<!-- WORKER URL -->
<script>
  const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
  const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";

  const TWITCH_WORKER = "URL_DEL_TUO_WORKER_TWITCH";
  const TWITCH_CHANNEL = "il_tuo_canale";
</script>

<!-- LOGICA PROGRESS + TIMELINE -->
<script>
async function loadDifficulty(diff, id) {
  const box = document.getElementById(id);
  try {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();
    const bosses = Object.keys(data.bosses || {});
    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const inProg = bosses.filter(b => data.bosses[b].kills === 0 && data.bosses[b].bestPercentage < 100);

    const best = inProg.length ? Math.min(...inProg.map(b => data.bosses[b].bestPercentage)) : "–";

    box.innerHTML = `
      <div><strong>Kill:</strong> ${killed.length}/${bosses.length}</div>
      <div><strong>Progress:</strong> ${inProg.length}</div>
      <div><strong>Best Pull:</strong> ${best}%</div>
      <div class="boss-list">
        ${killed.map(b => `<span class="boss-killed">${b}</span>`).join("")}
        ${inProg.map(b => `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`).join("")}
      </div>
    `;
  } catch {
    box.innerHTML = "Errore nel caricamento.";
  }
}

async function fetchLast() {
  const summary = document.getElementById("last-session-summary");
  const pill = document.getElementById("pill-timeline");

  const res = await fetch(`${WORKER_LAST}/progress-last`);
  const last = await res.json();
  const bosses = Object.values(last.bosses || {});

  if (last.latestReport?.code) {
    const l = document.getElementById("last-session-report-link");
    l.href = `https://www.warcraftlogs.com/reports/${last.latestReport.code}`;
    l.style.display = "inline-block";
  }

  const pulls = bosses.reduce((a,b)=>a+b.pulls,0);
  const wipes = bosses.reduce((a,b)=>a+b.wipes,0);
  const kills = bosses.reduce((a,b)=>a+b.kills,0);

  summary.innerHTML = `
    <strong>Boss:</strong> ${bosses.length} —
    <strong>Pull:</strong> ${pulls} —
    <strong>Wipe:</strong> ${wipes} —
    <strong>Kill:</strong> ${kills}
  `;

  pill.innerHTML = bosses.map(b => `
    <div class="pill ${b.kills>0 ? "kill" : "progress"}">
      <div class="pill-title">${b.bossName}</div>
      <div class="pill-info">${b.kills>0?"Kill ✔️":`Best ${b.bestPercentage}%`}</div>
    </div>
  `).join("");
}

async function loadTwitch() {
  const c = document.getElementById("twitch-live-container");
  const r = await fetch(`${TWITCH_WORKER}?channel=${TWITCH_CHANNEL}`);
  const d = await r.json();

  if (d.isLive) {
    c.innerHTML = `
      <div class="twitch-wrapper">
        <iframe
          src="https://player.twitch.tv/?channel=${TWITCH_CHANNEL}&parent=lucasantoro.github.io"
          frameborder="0"
          allowfullscreen="true"
          scrolling="no"
          height="420"
          width="100%">
        </iframe>
      </div>`;
  } else {
    c.innerHTML = `
      <div class="twitch-offline">
        <h3>Live offline</h3>
        <p>Guarda i VOD dell'ultima serata!</p>
        <a href="https://twitch.tv/${TWITCH_CHANNEL}/videos" class="vod-button" target="_blank">Vai ai VOD</a>
      </div>`;
  }
}

(async ()=>{
  loadDifficulty("normal","card-normal");
  loadDifficulty("heroic","card-heroic");
  loadDifficulty("mythic","card-mythic");
  await fetchLast();
  await loadTwitch();
})();
</script>

</body>
</html>
