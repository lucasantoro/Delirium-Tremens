<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MindBound – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
/* ==========================================
   HERO & GENERAL – unchanged
========================================== */
.hero {
  padding: 80px 20px 50px;
  background: none;
  height: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.hero h2 {
  font-size: 3rem;
  color: #fff;
  margin-bottom: 12px;
  opacity: 0;
  transform: translateY(25px);
  animation: fadeUp .9s ease forwards;
}
.hero p {
  font-size: 1.3rem;
  opacity: 0;
  max-width: 720px;
  margin: 0 auto;
  transform: translateY(20px);
  animation: fadeUp 1.3s ease forwards;
}
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

/* ==========================================
   BG LOGO
========================================== */
.bg-container {
  position: relative;
  background: url('../../img/mindbound_logo.png') center/cover no-repeat;
  padding: 60px 0 80px;
}
.bg-container::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(2px);
}
.bg-container > * { position: relative; z-index: 2; }

/* ==========================================
   LIVE TWITCH – UPDATED
========================================== */

.live-raid-card {
  background: rgba(15,15,15,0.9);
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.15);
  padding: 16px 18px 18px;
  margin-bottom: 20px;
  box-shadow: 0 0 18px rgba(120,120,255,0.35);
}

/* Player grande quando ONLINE */
.live-player-shell {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  border-radius: 10px;
  margin-top: 10px;
}
.live-player-shell iframe {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

/* Card compatta quando OFFLINE */
.live-offline-box {
  margin-top: 10px;
  padding: 25px;
  text-align: center;
  background: rgba(40,40,40,0.4);
  border-radius: 10px;
  border: 1px dashed rgba(255,255,255,0.25);
  font-size: 1rem;
  color: #ccc;
}

/* Pills */
.live-status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  padding: 4px 10px;
  border-radius: 999px;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border: 1px solid rgba(255,255,255,0.2);
}
.live-dot {
  width: 8px; height: 8px; border-radius: 50%;
}
.live-status-live {
  background: rgba(220,20,60,0.15);
  border-color: rgba(255,80,120,0.8);
  color: #ff9ea8;
}
.live-status-live .live-dot {
  background: #ff3b5c;
  box-shadow: 0 0 6px rgba(255,0,70,0.9);
}
.live-status-offline {
  background: rgba(80,80,80,0.2);
  color: #ccc;
}
.live-status-offline .live-dot {
  background: #777;
}

/* ==========================================
   ROSTER – UPDATED (icone classi)
========================================== */

.roster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px 14px;
  margin-top: 10px;
}

.roster-section-title {
  font-size: 1.1rem;
  margin: 18px 0 6px;
  color: #fff;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 4px;
}

.roster-item-main {
  display: flex;
  align-items: center;
  gap: 6px;
}

.class-icon {
  width: 18px; height: 18px;
  background-size: cover;
  border-radius: 3px;
}

/* class icons sample – feel free to replace with your icons */
.class-Warrior     { background-image:url('../../img/classes/warrior.png'); }
.class-Paladin     { background-image:url('../../img/classes/paladin.png'); }
.class-Hunter      { background-image:url('../../img/classes/hunter.png'); }
.class-Rogue       { background-image:url('../../img/classes/rogue.png'); }
.class-Priest      { background-image:url('../../img/classes/priest.png'); }
.class-DeathKnight { background-image:url('../../img/classes/deathknight.png'); }
.class-Shaman      { background-image:url('../../img/classes/shaman.png'); }
.class-Mage        { background-image:url('../../img/classes/mage.png'); }
.class-Warlock     { background-image:url('../../img/classes/warlock.png'); }
.class-Monk        { background-image:url('../../img/classes/monk.png'); }
.class-Druid       { background-image:url('../../img/classes/druid.png'); }
.class-DemonHunter { background-image:url('../../img/classes/demonhunter.png'); }

/* role color tags */
.roster-role-tag {
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.2);
  text-transform: uppercase;
  letter-spacing: .05em;
}
.roster-role-tank { border-color:#4fd1c5; }
.roster-role-heal { border-color:#63b3ed; }
.roster-role-dps  { border-color:#f6ad55; }
  </style>
</head>

<body>

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="../mindbound/mindbound.html">Home Team</a></li>
    <li><a href="../mindbound/roster-mindbound.html">Roster</a></li>
    <li><a href="../mindbound/mindbound-news.html">News</a></li>
    <li><a href="../mindbound/mindbound-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<div class="bg-container">
  <main class="panel">

    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">Stato del raid per Normal, Heroic e Mythic.</p>

    <div class="widgets-grid">
      <div class="widget-card"><h3>Normal</h3><div id="card-normal">Caricamento…</div></div>
      <div class="widget-card"><h3>Heroic</h3><div id="card-heroic">Caricamento…</div></div>
      <div class="widget-card"><h3>Mythic</h3><div id="card-mythic">Caricamento…</div></div>
    </div>

    <!-- ==================== LIVE TWITCH ==================== -->
    <div class="live-raid-card">
      <div id="live-status-pill" class="live-status-pill live-status-offline">
        <span class="live-dot"></span> Offline
      </div>

      <h3>Diretta raid – Twitch</h3>
      <p id="live-description">Il canale è offline. Prossimo evento a breve.</p>

      <div id="live-player-shell"></div>

      <div id="live-offline-box" class="live-offline-box" style="display:none;">
        Offline – prossimo evento a breve.
      </div>
    </div>

    <!-- ==================== SESSIONE RAID ==================== -->
    <h2 class="section-title">Ultima sessione raid</h2>
    <p class="section-subtitle">Resoconto completo della serata MindBound.</p>

    <div id="last-session-summary" class="session-summary-card">Caricamento…</div>
    <div id="dot-timeline" class="dot-timeline-container"></div>

    <div style="text-align:center; margin-top:20px;">
      <a id="last-session-report-link" class="apply-button" target="_blank" style="display:none;">
        Apri il report dell’ultima sessione
      </a>
    </div>

    <!-- ==================== ROSTER ==================== -->
    <div class="session-roster-card">
      <h3 class="widget-title">Roster ultimo pull</h3>
      <div id="live-roster">Caricamento roster…</div>
    </div>

  </main>
</div>

<footer><p>© 2025 Delirium Tremens</p></footer>

<script>
const WORKER_FULL  = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
const WORKER_LAST  = "https://wild-mode-1b45.lucasantoro2905.workers.dev";
const WORKER_TWITCH = "https://twitch-live.lucasantoro2905.workers.dev";
const TWITCH_CHANNEL = "londe83";

/* ============================================================
   TWITCH LIVE – UPDATED LOGIC
============================================================ */
async function fetchTwitchLive() {
  const url = `${WORKER_TWITCH}/twitch-live?channel=${encodeURIComponent(TWITCH_CHANNEL)}`;
  const res = await fetch(url);
  return res.json();
}

function renderTwitchLive(data) {
  const pill  = document.getElementById("live-status-pill");
  const desc  = document.getElementById("live-description");
  const shell = document.getElementById("live-player-shell");
  const offlineBox = document.getElementById("live-offline-box");

  if (!data.live) {
    pill.classList.add("live-status-offline");
    pill.classList.remove("live-status-live");
    desc.innerText = "Il canale è offline. Prossimo evento a breve.";
    shell.innerHTML = "";
    offlineBox.style.display = "block";
    return;
  }

  // LIVE
  pill.classList.remove("live-status-offline");
  pill.classList.add("live-status-live");
  offlineBox.style.display = "none";

  desc.innerText = `${data.title || "Diretta raid"} • ${data.game_name || ""}`;

  const parent = window.location.hostname;
  const embed = `https://player.twitch.tv/?channel=${TWITCH_CHANNEL}&parent=${parent}`;

  shell.innerHTML = `
    <iframe src="${embed}" allowfullscreen="true" allow="autoplay;fullscreen"></iframe>
  `;
}

/* ============================================================
   ROSTER LAST PULL – UPDATED
============================================================ */
function renderRoster(last) {
  const container = document.getElementById("live-roster");
  if (!last.lastPullRoster) {
    container.innerHTML = "Roster non disponibile.";
    return;
  }

  const roster = last.lastPullRoster;

  const groups = { tank: [], healer: [], dps: [] };

  roster.forEach(p => {
    const role = (p.role || "").toLowerCase();
    if (role.includes("tank")) groups.tank.push(p);
    else if (role.includes("heal")) groups.healer.push(p);
    else groups.dps.push(p);
  });

  function block(name, list) {
    if (!list.length) return "";
    return `
      <div class="roster-section-title">${name}</div>
      <div class="roster-grid">
        ${list.map(p => `
          <div class="roster-item">
            <div class="roster-item-main">
              <div class="class-icon class-${p.class}"></div>
              ${p.name}
              <span class="roster-role-tag roster-role-${p.role}">${p.role}</span>
            </div>
            <div class="roster-meta">${p.class} – ${p.spec || ""}</div>
          </div>
        `).join("")}
      </div>
    `;
  }

  container.innerHTML =
    block("Tank", groups.tank) +
    block("Healer", groups.healer) +
    block("DPS", groups.dps);
}

/* ============================================================
   SESSION, DIFFICULTIES, ETC.
   (tutta la tua logica originale rimane invariata)
============================================================ */

async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

/* ... (tutta la tua parte timeline e difficulty resta lì invariata) ... */

/* ============================================================
   INIT
============================================================ */
(async function init() {
  // load diff cards
  loadDifficulty("normal", "card-normal");
  loadDifficulty("heroic", "card-heroic");
  loadDifficulty("mythic", "card-mythic");

  // last session
  const last = await fetchLastSession();
  renderLastSessionTimeline(last);
  renderRoster(last);

  // twitch
  const live = await fetchTwitchLive();
  renderTwitchLive(live);
})();
</script>

</body>
</html>
