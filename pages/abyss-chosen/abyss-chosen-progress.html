<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Abyss Chosen – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">

  <style>
    body {
      background: #0b0b0b;
      color: #ccc;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    /* HEADER COERENTE */
    header {
      text-align: center;
      padding: 25px 0 10px;
    }
    header h1 {
      color: #fff;
      font-size: 2.2rem;
      text-shadow: 0 0 12px rgba(255,80,80,0.5);
      margin: 0;
    }
    header nav ul {
      list-style: none;
      display: flex;
      justify-content: center;
      gap: 25px;
      padding: 0;
      margin-top: 15px;
    }
    header nav a {
      color: #fff;
      text-decoration: none;
      font-size: 1.05rem;
      transition: .3s;
    }
    header nav a:hover,
    header nav a.active {
      color: #ff5050;
      text-shadow: 0 0 8px #ff5050;
    }

    /* HERO INTRO */
    .hero-progress {
      padding: 50px 20px 30px;
      text-align: center;
    }
    .hero-progress h2 {
      font-size: 2.4rem;
      color: #fff;
      opacity: 0;
      animation: fadeUp .9s ease forwards;
    }
    .hero-progress p {
      opacity: 0;
      max-width: 750px;
      margin: 18px auto 0;
      color: #ccc;
      font-size: 1.1rem;
      animation: fadeUp 1.3s ease forwards;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* CONTENITORE SFONDO UNICO */
    .bg-container {
      position: relative;
      background: url('../../img/logo.png') center/cover no-repeat;
      padding: 60px 0 80px;
    }
    .bg-container::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(2px);
    }
    .bg-container > * {
      position: relative;
      z-index: 2;
    }

    main.panel {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h2.section-title {
      text-align: center;
      color: #fff;
      font-size: 2rem;
      margin: 20px 0 10px;
    }
    p.section-subtitle {
      text-align: center;
      max-width: 800px;
      margin: 0 auto 25px;
      color: #ddd;
      font-size: 1rem;
    }

    /* CARD LAYOUT */
    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
      margin: 35px 0 10px;
    }

    .widget-card {
      background: rgba(15,15,15,0.8);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 18px 18px 16px;
      box-shadow: 0 0 18px rgba(255,80,80,0.35);
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: scale(0.97);
      animation: fadeZoom .7s ease forwards;
    }

    .widget-card::before {
      content: "";
      position: absolute;
      top: -120%;
      left: -120%;
      width: 60%;
      height: 320%;
      background: linear-gradient(
        120deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.16) 50%,
        rgba(255,255,255,0) 100%
      );
      transform: rotate(25deg);
      transition: .8s;
    }
    .widget-card:hover::before {
      top: -40%;
      left: 130%;
    }

    .widget-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 25px rgba(255,80,80,0.6);
      border-color: rgba(255,80,80,0.45);
    }

    .widget-title {
      font-size: 1.2rem;
      color: #fff;
      margin: 0 0 6px;
    }
    .widget-desc {
      font-size: 0.95rem;
      color: #ddd;
      margin: 0 0 10px;
    }

    .progress-content {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 10px 12px;
      background: rgba(5,5,5,0.6);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .progress-line {
      margin: 4px 0;
    }

    .boss-list {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .boss-list span {
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 4px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.04);
    }
    .boss-killed {
      color: #9fffba;
      border: 1px solid rgba(80,255,120,0.4);
    }
    .boss-progress {
      color: #ffeab4;
      border: 1px solid rgba(255,200,80,0.4);
    }

    @keyframes fadeZoom {
      to { opacity: 1; transform: scale(1); }
    }

    footer {
      text-align: center;
      padding: 30px 0;
      color: #777;
    }
  </style>
</head>

<body class="page-transition">

<header>
  <h1>Abyss Chosen</h1>
  <nav>
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<section class="hero-progress">
  <h2>Progress Raid – Abyss Chosen</h2>
  <p>
    Panoramica della progressione del team nelle tre difficolt&agrave; del tier attuale,
    con dati aggiornati da Warcraft Logs tramite API.
  </p>
</section>

<div class="bg-container">
  <main class="panel">

    <!-- BLOCCO: PROGRESS ATTUALE PER DIFFICOLTÀ -->
    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Una vista rapida su quanti boss sono stati sconfitti, quali sono in progress
      e quale &egrave; stato finora il miglior pull per ciascuna difficolt&agrave;.
    </p>

    <div class="widgets-grid">

      <!-- NORMAL -->
      <div class="widget-card">
        <h3 class="widget-title">Progress Normal</h3>
        <p class="widget-desc">
          Stato complessivo dei boss in difficolt&agrave; Normal per il tier corrente.
        </p>
        <div class="progress-content" id="progress-normal">
          Caricamento dati da Warcraft Logs...
        </div>
      </div>

      <!-- HEROIC -->
      <div class="widget-card">
        <h3 class="widget-title">Progress Heroic</h3>
        <p class="widget-desc">
          Avanzamento sullo stesso tier in difficolt&agrave; Heroic.
        </p>
        <div class="progress-content" id="progress-heroic">
          Caricamento dati da Warcraft Logs...
        </div>
      </div>

      <!-- MYTHIC -->
      <div class="widget-card">
        <h3 class="widget-title">Progress Mythic</h3>
        <p class="widget-desc">
          Situazione aggiornate dei boss affrontati in difficolt&agrave; Mythic.
        </p>
        <div class="progress-content" id="progress-mythic">
          Caricamento dati da Warcraft Logs...
        </div>
      </div>

    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Delirium Tremens</p>
</footer>

<script>
  // =====================
  // CONFIGURAZIONE API
  // =====================
  const CLIENT_ID = "a06a1bd0-f307-4305-af0f-7bb4d82de802";
  const CLIENT_SECRET = "e7oB3YOOkWdMWIEMMxsJKvlp3yso9hVVXWdZxJiX";

  // ATTENZIONE: questo NON è il "guild=802526" degli embed.
  // Il GraphQL di solito lavora per nome/regione/server.
  // Ti lascio entrambe le versioni: per ID (commentata) e per nome/slug.
  const GUILD_NAME = "DeliriumTremens";   // <-- metti nome esatto come su WCL
  const SERVER_SLUG = "nemesis"; // <-- tipo 'pozzo-delleternita' / 'draenor' ecc.
  const SERVER_REGION = "eu";              // 'EU', 'US', ecc.

  const ZONE_ID = 44; // Tier attuale

  // Difficulties: 3 = Normal, 4 = Heroic, 5 = Mythic
  const DIFFS = [
    { diff: 3, elementId: "progress-normal" },
    { diff: 4, elementId: "progress-heroic" },
    { diff: 5, elementId: "progress-mythic" }
  ];

  // =====================
  // OAUTH TOKEN
  // =====================
  async function getToken() {
    const res = await fetch("https://www.warcraftlogs.com/oauth/token", {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: `grant_type=client_credentials&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}`
    });

    if (!res.ok) {
      console.error("Errore ottenendo il token:", res.status, res.statusText);
      throw new Error("Impossibile ottenere il token dalle API WCL.");
    }

    const data = await res.json();
    return data.access_token;
  }

  // =====================
  // QUERY GRAPHQL
  // =====================
  const QUERY = `
    query ($guildName: String!, $serverSlug: String!, $serverRegion: String!, $zoneId: Int!, $difficulty: Int!) {
      guildData {
        guild(name: $guildName, serverSlug: $serverSlug, serverRegion: $serverRegion) {
          zoneRankings(zoneID: $zoneId, difficulty: $difficulty) {
            rankings {
              encounter {
                id
                name
              }
              totalKills
              bestPercentage
              bestDuration
            }
          }
        }
      }
    }
  `;

  async function fetchProgress(token, difficulty) {
    const res = await fetch("https://www.warcraftlogs.com/api/v2/client", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        query: QUERY,
        variables: {
          guildName: GUILD_NAME,
          serverSlug: SERVER_SLUG,
          serverRegion: SERVER_REGION,
          zoneId: ZONE_ID,
          difficulty: difficulty
        }
      })
    });

    const json = await res.json();

    // DEBUG: vedi in console esattamente cosa torna l'API
    console.log("Risposta WCL difficulty", difficulty, json);

    // Se ci sono errori GraphQL, niente data
    if (json.errors) {
      console.error("Errori GraphQL:", json.errors);
      throw new Error("Errore GraphQL WCL");
    }

    if (!json.data || !json.data.guildData || !json.data.guildData.guild) {
      console.error("Struttura dati inattesa dalla API:", json);
      throw new Error("Dati gilda non disponibili (controlla nome/server/region).");
    }

    const zoneRankings = json.data.guildData.guild.zoneRankings;
    if (!zoneRankings || !zoneRankings.rankings) {
      console.error("zoneRankings mancante:", json);
      throw new Error("Nessun ranking disponibile per questo tier/difficoltà.");
    }

    return zoneRankings.rankings;
  }

  // =====================
  // RENDER DEI DATI
  // =====================
  function renderDifficulty(containerId, bosses) {
    const el = document.getElementById(containerId);
    if (!el) return;

    if (!bosses || bosses.length === 0) {
      el.textContent = "Nessun dato disponibile per questa difficolt\u00E0.";
      return;
    }

    const totalBosses = bosses.length;
    const killed = bosses.filter(b => b.totalKills > 0);
    const inProgress = bosses.filter(b => b.totalKills === 0 && b.bestPercentage !== null && b.bestPercentage < 100);

    const bestPulls = inProgress.map(b => b.bestPercentage);
    const bestOverall = bestPulls.length > 0 ? Math.min(...bestPulls) : null;

    let html = "";
    html += `<div class="progress-line"><strong>Boss sconfitti:</strong> ${killed.length} / ${totalBosses}</div>`;
    html += `<div class="progress-line"><strong>Boss in progress:</strong> ${inProgress.length}</div>`;
    html += `<div class="progress-line"><strong>Miglior pull attuale:</strong> ${bestOverall !== null ? bestOverall + "%" : "–"}</div>`;

    html += `<div class="boss-list">`;
    killed.forEach(b => {
      html += `<span class="boss-killed">${b.encounter.name}</span>`;
    });
    inProgress.forEach(b => {
      html += `<span class="boss-progress">${b.encounter.name} (${b.bestPercentage}%)</span>`;
    });
    html += `</div>`;

    el.innerHTML = html;
  }

  // =====================
  // MAIN
  // =====================
  (async function init() {
    try {
      const token = await getToken();

      for (const { diff, elementId } of DIFFS) {
        const el = document.getElementById(elementId);
        if (el) el.textContent = "Caricamento dati da Warcraft Logs...";

        try {
          const bosses = await fetchProgress(token, diff);
          renderDifficulty(elementId, bosses);
        } catch (err) {
          console.error("Errore per difficoltà", diff, err);
          if (el) el.textContent = "Errore nel caricamento dei dati per questa difficolt\u00E0.";
        }
      }

    } catch (err) {
      console.error("Errore generale init()", err);
      DIFFS.forEach(({ elementId }) => {
        const el = document.getElementById(elementId);
        if (el) el.textContent = "Impossibile connettersi alle API Warcraft Logs.";
      });
    }
  })();
</script>


</body>
</html>
