<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Abyss Chosen – Progress</title>
<link rel="stylesheet" href="../../css/style.css">
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.chart-loader {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
}

.loader {
  border: 6px solid rgba(255,255,255,0.2);
  border-top: 6px solid #fff;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.hidden {
  display: none !important;
}
</style>


</head>

<body class="page-transition abyss-bg">

<header>
  <h1>Abyss Chosen</h1>
  <nav>
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="../abyss-chosen/abyss-chosen.html">Home Team</a></li>
    <li><a href="../abyss-chosen/roster-abyss.html">Roster</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-news.html">News</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<main class="panel progress-panel">

  <!-- ======================================================
                PROGRESS COMPLETO (FULL)
  ======================================================= -->
  <section class="current-progress">
    <h2>Progress Completo</h2>

    <div class="chart-wrapper">
      <div id="loaderFull" class="chart-loader">
        <div class="loader"></div>
      </div>
      <canvas id="fullProgressChart" class="hidden" height="200"></canvas>
    </div>



    <p class="raid-summary">
      Questo grafico mostra lo stato reale del progress in Normal, Heroic e Mythic.
    </p>
  </section>

  <!-- ======================================================
                ULTIMA SESSIONE
  ======================================================= -->
  <section class="current-progress">
    <h2>Ultima Sessione (Mythic)</h2>

    <div class="chart-wrapper">
      <div id="loaderLast" class="chart-loader">
        <div class="loader"></div>
      </div>
      <canvas id="lastSessionChart" class="hidden" height="200"></canvas>
    </div>



    <p class="raid-summary">
      Questo grafico mostra solo ciò che è stato fatto nell’ultimo raid registrato.
    </p>
  </section>


  <!-- ======================================================
                LINK LOGS
  ======================================================= -->
  <section class="progress-logs">
    <h2>Warcraft Logs</h2>
    <p>Analizza fight, performance, strategie e miglioramenti del team.</p>

    <a href="https://www.warcraftlogs.com/guild/eu/nemesis/DeliriumTremens"
       target="_blank" class="apply-button">
      Apri i Logs degli Abyss Chosen
    </a>
  </section>

</main>

<footer>
<p>&copy; 2025 Delirium Tremens</p>
</footer>

<!-- ==========================
    FADE-IN / FADE-OUT SCRIPT
========================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");
});
document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function(e){
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- ==========================
      URL CLOUDFLARE WORKERS
========================== -->
<script>
const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";  
const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";  
// deve essere il dominio del worker, senza endpoint finale
// es: "https://manaforge-progress.workers.dev"
</script>

<!-- ==========================
     FETCH + CHARTJS SCRIPT
========================== -->
<script>
// ================================
// FETCH DATA per FULL progress
// ================================
async function fetchFullProgress() {
  const diffs = ["normal", "heroic", "mythic"];
  const results = {};

  for (const d of diffs) {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${d}`);
    results[d] = await res.json();
  }

  return results;
}

// ================================
// FETCH DATA per LAST SESSION
// ================================
async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

// ================================
// RENDER FULL PROGRESS
// ================================
function renderFullChart(full) {
  document.getElementById("loaderFull").classList.add("hidden");
  document.getElementById("fullProgressChart").classList.remove("hidden");

  const bossSet = new Set();

  Object.values(full).forEach(diff => {
    if (!diff.bosses) return;
    for (const b in diff.bosses) bossSet.add(b);
  });

  const bosses = Array.from(bossSet);

  const normal = bosses.map(b => full.normal?.bosses?.[b]?.kills ? 1 : 0);
  const heroic = bosses.map(b => full.heroic?.bosses?.[b]?.kills ? 1 : 0);
  const mythic = bosses.map(b => full.mythic?.bosses?.[b]?.kills ? 1 : 0);

  new Chart(document.getElementById("fullProgressChart"), {
    type: "bar",
    data: {
      labels: bosses,
      datasets: [
        { label: "Normal", data: normal, backgroundColor: "#4CAF50" },
        { label: "Heroic", data: heroic, backgroundColor: "#FFC107" },
        { label: "Mythic", data: mythic, backgroundColor: "#E91E63" }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { max: 1, ticks: { color: "#fff" } },
        x: { ticks: { color: "#fff" } }
      },
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });
}


// ================================
// RENDER LAST SESSION
// ================================
function renderLastChart(last) {

  // Nasconde il loader e mostra il canvas
  document.getElementById("loaderLast").classList.add("hidden");
  const canvas = document.getElementById("lastSessionChart");
  canvas.classList.remove("hidden");

  const bosses = Object.keys(last.bosses || {});

  if (bosses.length === 0) {
    canvas.outerHTML = "<p style='color:white;text-align:center;'>Nessun dato per l'ultimo raid.</p>";
    return;
  }

  const pulls = bosses.map(b => last.bosses[b].pulls);
  const wipes = bosses.map(b => last.bosses[b].wipes);
  const kills = bosses.map(b => last.bosses[b].kills);
  const bestPct = bosses.map(b => last.bosses[b].bestPercentage ?? 100);

  // deduce the actual difficulty played
  const diffs = new Set();
  bosses.forEach(b => last.bosses[b].difficultiesSeen?.forEach(d => diffs.add(d)));

  const diffName =
    diffs.has(5) ? "Mythic" :
    diffs.has(4) ? "Heroic" :
    diffs.has(3) ? "Normal" :
    "N/A";

  // update title dynamically
  document.querySelector("section.current-progress:nth-of-type(2) h2").textContent =
    `Ultima Sessione (${diffName})`;

  const ctx = canvas.getContext("2d");

  new Chart(ctx, {
    data: {
      labels: bosses,
      datasets: [
        {
          type: "bar",
          label: "Pulls",
          data: pulls,
          backgroundColor: "rgba(41,150,246,0.7)"
        },
        {
          type: "bar",
          label: "Wipes",
          data: wipes,
          backgroundColor: "rgba(255,90,0,0.7)"
        },
        {
          type: "bar",
          label: "Kills",
          data: kills,
          backgroundColor: "rgba(0,200,70,0.8)"
        },
        {
          type: "line",
          label: "Best % (0 = kill)",
          data: bestPct,
          borderColor: "#ff005d",
          backgroundColor: "#ff005d",
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3,
          yAxisID: "y1",
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          type: "linear",
          position: "left",
          beginAtZero: true,
          title: { display: true, text: "Pulls / Wipes / Kills", color: "#fff" },
          ticks: { color: "#fff" }
        },
        y1: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          max: 100,
          title: { display: true, text: "Best %", color: "#ff69a6" },
          ticks: { color: "#ff69a6" },
          grid: { drawOnChartArea: false }
        },
        x: {
          ticks: { color: "#fff" }
        }
      },
      plugins: {
        legend: { labels: { color: "#fff" } }
      }
    }
  });
}



// ================================
// LOAD EVERYTHING
// ================================
(async () => {
  console.log("=== FETCH FULL PROGRESS ===");
  const full = await fetchFullProgress();
  console.log("FULL:", full);

  console.log("=== FETCH LAST SESSION ===");
  const last = await fetchLastSession();
  console.log("LAST:", last);

  // Render
  renderFullChart(full);

  // Titolo dinamico
  if (last && last.difficulty) {
    document.querySelector("section:nth-of-type(2) h2").textContent =
      `Ultima Sessione (${last.difficulty})`;
  }

  renderLastChart(last);
})();

</script>

</body>
</html>
