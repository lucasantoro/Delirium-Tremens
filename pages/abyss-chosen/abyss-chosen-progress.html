<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Delirium Tremens – Progress</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #0b0b0b;
      color: #ccc;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    /* HEADER COERENTE CON SITO */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 25px 0 10px;
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
      color: #fff;
      letter-spacing: 1px;
    }
    .mainnav ul {
      display: flex;
      gap: 30px;
      list-style: none;
      margin-top: 15px;
      padding: 0;
    }
    .mainnav a {
      color: #fff;
      text-decoration: none;
      font-size: 1.1rem;
      transition: .3s;
    }
    .mainnav a:hover,
    .mainnav a.active {
      color: #b86bff;
      text-shadow: 0 0 8px #b86bff;
    }

    /* HERO INTRO */
    .hero-progress {
      padding: 50px 20px 30px;
      text-align: center;
    }
    .hero-progress h2 {
      font-size: 2.4rem;
      color: #fff;
      opacity: 0;
      animation: fadeUp .9s ease forwards;
    }
    .hero-progress p {
      opacity: 0;
      max-width: 750px;
      margin: 18px auto 0;
      color: #ccc;
      font-size: 1.1rem;
      animation: fadeUp 1.3s ease forwards;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* SFONDO CON LOGO */
    .bg-container {
      position: relative;
      background: url('../img/logo.png') center/cover no-repeat;
      padding: 60px 0 80px;
    }
    .bg-container::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(2px);
    }
    .bg-container > * {
      position: relative;
      z-index: 2;
    }

    main.panel {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h2.section-title {
      text-align: center;
      color: #fff;
      font-size: 2rem;
      margin: 20px 0 10px;
    }
    p.section-subtitle {
      text-align: center;
      max-width: 800px;
      margin: 0 auto 25px;
      color: #ddd;
      font-size: 1rem;
    }

    /* GRID CARD (PANORAMICA) */
    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
      margin: 35px 0 10px;
    }

    .widget-card {
      background: rgba(15,15,15,0.8);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 18px 18px 16px;
      box-shadow: 0 0 18px rgba(184,107,255,0.35);
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: scale(0.97);
      animation: fadeZoom .7s ease forwards;
    }

    .widget-card::before {
      content: "";
      position: absolute;
      top: -120%;
      left: -120%;
      width: 60%;
      height: 320%;
      background: linear-gradient(
        120deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.16) 50%,
        rgba(255,255,255,0) 100%
      );
      transform: rotate(25deg);
      transition: .8s;
    }
    .widget-card:hover::before {
      top: -40%;
      left: 130%;
    }

    .widget-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 25px rgba(184,107,255,0.6);
      border-color: rgba(184,107,255,0.45);
    }

    .widget-title {
      font-size: 1.2rem;
      color: #fff;
      margin: 0 0 6px;
    }
    .widget-desc {
      font-size: 0.95rem;
      color: #ddd;
      margin: 0 0 10px;
    }

    .progress-content {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 10px 12px;
      background: rgba(5,5,5,0.6);
      font-size: 0.95rem;
      line-height: 1.5;
      min-height: 140px;
    }

    .progress-line {
      margin: 4px 0;
    }

    .boss-list {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .boss-list span {
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 4px;
      padding: 3px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.04);
    }
    .boss-killed {
      color: #9fffba;
      border: 1px solid rgba(80,255,120,0.4);
    }
    .boss-progress {
      color: #ffeab4;
      border: 1px solid rgba(255,200,80,0.4);
    }

    @keyframes fadeZoom {
      to { opacity: 1; transform: scale(1); }
    }

    /* SEZIONE ULTIMA SESSIONE */
    .widget-full {
      margin-top: 40px;
    }

    .chart-wrapper {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 16px;
      background: rgba(15,15,15,0.8);
      box-shadow: 0 0 18px rgba(184,107,255,0.35);
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
    }

    .chart-wrapper::before {
      content: "";
      position: absolute;
      top: -120%;
      left: -120%;
      width: 60%;
      height: 320%;
      background: linear-gradient(
        120deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.16) 50%,
        rgba(255,255,255,0) 100%
      );
      transform: rotate(25deg);
      transition: .8s;
    }
    .chart-wrapper:hover::before {
      top: -40%;
      left: 130%;
    }

    .chart-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 220px;
    }
    .loader {
      border: 6px solid rgba(255,255,255,0.2);
      border-top: 6px solid #fff;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    footer {
      text-align: center;
      padding: 30px 0;
      color: #777;
    }
  </style>
</head>

<body class="page-transition">

<header>
  <h1>Delirium Tremens</h1>
  <nav class="mainnav">
    <ul>
      <li><a href="../index.html">Home</a></li>
      <li><a href="raider.html">Raider</a></li>
      <li><a href="hollowsoul.html">Hollow Soul</a></li>
      <li><a href="progress.html" class="active">Progress</a></li>
      <li><a href="recruiting.html">Reclutamento</a></li>
      <li><a href="statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<section class="hero-progress">
  <h2>Progress Raid – Delirium Tremens</h2>
  <p>
    Una dashboard che riassume lo stato della progressione della gilda nel tier attuale:
    panoramica per difficolt&agrave; e ultima sessione di raid.
  </p>
</section>

<div class="bg-container">
  <main class="panel">

    <!-- PANORAMICA PER DIFFICOLTÀ -->
    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Quanti boss sono stati sconfitti, quali sono ancora in progress e qual &egrave; stato il miglior pull per ciascuna difficolt&agrave;.
    </p>

    <div class="widgets-grid">
      <!-- NORMAL -->
      <div class="widget-card">
        <h3 class="widget-title">Normal</h3>
        <p class="widget-desc">Progress generale della gilda in difficolt&agrave; Normal.</p>
        <div class="progress-content" id="card-normal">
          Caricamento...
        </div>
      </div>

      <!-- HEROIC -->
      <div class="widget-card">
        <h3 class="widget-title">Heroic</h3>
        <p class="widget-desc">Stato dell'avanzamento in difficolt&agrave; Heroic.</p>
        <div class="progress-content" id="card-heroic">
          Caricamento...
        </div>
      </div>

      <!-- MYTHIC -->
      <div class="widget-card">
        <h3 class="widget-title">Mythic</h3>
        <p class="widget-desc">La punta del progress, in difficolt&agrave; Mythic.</p>
        <div class="progress-content" id="card-mythic">
          Caricamento...
        </div>
      </div>
    </div>

    <!-- ULTIMA SESSIONE -->
    <div class="widget-full">
      <h2 class="section-title" id="last-session-title">Ultima sessione raid</h2>
      <p class="section-subtitle">
        Riepilogo di ci&ograve; che &egrave; successo nell'ultimo raid: pull, wipe, kill e migliori percentuali sui boss affrontati.
      </p>

      <div class="chart-wrapper">
        <div id="loaderLast" class="chart-loader">
          <div class="loader"></div>
        </div>
        <canvas id="lastSessionChart" class="hidden" height="220"></canvas>
      </div>
    </div>

    <!-- LINK LOGS -->
    <div class="widget-full" style="margin-top: 40px;">
      <h2 class="section-title">Warcraft Logs</h2>
      <p class="section-subtitle">
        Per l'analisi dettagliata dei fight, performance e replay dei pull,
        puoi consultare direttamente i log completi della gilda su Warcraft Logs.
      </p>
      <div style="text-align:center; margin-top: 15px;">
        <a href="https://www.warcraftlogs.com/guild/eu/nemesis/DeliriumTremens"
           target="_blank"
           class="apply-button">
          Apri i Warcraft Logs della gilda
        </a>
      </div>
    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Delirium Tremens</p>
</footer>

<!-- TRANSIZIONE PAGINE -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("page-loaded");
});

document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- URL WORKERS -->
<script>
  const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
  const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";
</script>

<!-- LOGICA PROGRESS (CARD + ULTIMA SESSIONE) -->
<script>
async function loadDifficulty(diff, elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;

  try {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();

    const bosses = Object.keys(data.bosses || {});
    const total = bosses.length;

    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const inProgress = bosses.filter(
      b => data.bosses[b].kills === 0 && data.bosses[b].bestPercentage !== null && data.bosses[b].bestPercentage < 100
    );

    let html = `
      <div class="progress-line"><strong>Boss sconfitti:</strong> ${killed.length} / ${total}</div>
      <div class="progress-line"><strong>Boss in progress:</strong> ${inProgress.length}</div>
    `;

    const bestPulls = inProgress.map(b => data.bosses[b].bestPercentage);
    const bestOverall = bestPulls.length > 0 ? Math.min(...bestPulls) : null;
    html += `<div class="progress-line"><strong>Miglior pull:</strong> ${bestOverall !== null ? bestOverall + "%" : "–"}</div>`;

    html += `<div class="boss-list">`;
    killed.forEach(b => {
      html += `<span class="boss-killed">${b}</span>`;
    });
    inProgress.forEach(b => {
      html += `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`;
    });
    html += `</div>`;

    el.innerHTML = html;

  } catch (err) {
    console.error("Errore caricamento progress", diff, err);
    el.textContent = "Errore nel caricamento dei dati.";
  }
}

async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

function renderLastChart(last) {
  const loader = document.getElementById("loaderLast");
  const canvas = document.getElementById("lastSessionChart");

  loader.classList.add("hidden");
  canvas.classList.remove("hidden");

  const bosses = Object.keys(last.bosses || {});

  if (bosses.length === 0) {
    canvas.outerHTML = "<p style='color:white;text-align:center;'>Nessun dato per l'ultimo raid.</p>";
    return;
  }

  const pulls = bosses.map(b => last.bosses[b].pulls);
  const wipes = bosses.map(b => last.bosses[b].wipes);
  const kills = bosses.map(b => last.bosses[b].kills);
  const bestPct = bosses.map(b => last.bosses[b].bestPercentage ?? 100);

  const diffs = new Set();
  bosses.forEach(b => last.bosses[b].difficultiesSeen?.forEach(d => diffs.add(d)));

  const diffName =
    diffs.has(5) ? "Mythic" :
    diffs.has(4) ? "Heroic" :
    diffs.has(3) ? "Normal" :
    "N/A";

  const titleEl = document.getElementById("last-session-title");
  titleEl.textContent = `Ultima sessione raid (${diffName})`;

  const ctx = canvas.getContext("2d");

  new Chart(ctx, {
    data: {
      labels: bosses,
      datasets: [
        {
          type: "bar",
          label: "Pulls",
          data: pulls,
          backgroundColor: "rgba(41,150,246,0.7)"
        },
        {
          type: "bar",
          label: "Wipes",
          data: wipes,
          backgroundColor: "rgba(255,90,0,0.7)"
        },
        {
          type: "bar",
          label: "Kills",
          data: kills,
          backgroundColor: "rgba(0,200,70,0.8)"
        },
        {
          type: "line",
          label: "Best % (0 = kill)",
          data: bestPct,
          borderColor: "#ff66cc",
          backgroundColor: "#ff66cc",
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3,
          yAxisID: "y1"
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          type: "linear",
          position: "left",
          beginAtZero: true,
          title: { display: true, text: "Pulls / Wipes / Kills", color: "#fff" },
          ticks: { color: "#fff" }
        },
        y1: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          max: 100,
          title: { display: true, text: "Best %", color: "#ff66cc" },
          ticks: { color: "#ff66cc" },
          grid: { drawOnChartArea: false }
        },
        x: {
          ticks: { color: "#fff" }
        }
      },
      plugins: {
        legend: { labels: { color: "#fff" } }
      }
    }
  });
}

(async () => {
  // Panoramica per difficoltà
  loadDifficulty("normal", "card-normal");
  loadDifficulty("heroic", "card-heroic");
  loadDifficulty("mythic", "card-mythic");

  // Ultima sessione
  try {
    const last = await fetchLastSession();
    console.log("Last session:", last);
    renderLastChart(last);
  } catch (err) {
    console.error("Errore nel caricamento dell'ultima sessione", err);
    const loader = document.getElementById("loaderLast");
    loader.innerHTML = "<p style='color:white;'>Errore nel caricamento dell'ultima sessione.</p>";
  }
})();
</script>

</body>
</html>
