<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Abyss Chosen – Progress</title>
<link rel="stylesheet" href="../../css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="page-transition abyss-bg">

<header>
  <h1>Abyss Chosen</h1>
  <nav>
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="../abyss-chosen/abyss-chosen.html">Home Team</a></li>
    <li><a href="../abyss-chosen/roster-abyss.html">Roster</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-news.html">News</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<main class="panel progress-panel">

  <!-- ======================================================
                PROGRESS COMPLETO (FULL)
  ======================================================= -->
  <section class="current-progress">
    <h2>Progress Completo</h2>

    <div class="chart-wrapper">
      <canvas id="fullProgressChart" height="200"></canvas>
    </div>

    <p class="raid-summary">
      Questo grafico mostra lo stato reale del progress in Normal, Heroic e Mythic.
    </p>
  </section>

  <!-- ======================================================
                ULTIMA SESSIONE
  ======================================================= -->
  <section class="current-progress">
    <h2>Ultima Sessione (Mythic)</h2>

    <div class="chart-wrapper">
      <canvas id="lastSessionChart" height="200"></canvas>
    </div>

    <p class="raid-summary">
      Questo grafico mostra solo ciò che è stato fatto nell’ultimo raid registrato.
    </p>
  </section>


  <!-- ======================================================
                LINK LOGS
  ======================================================= -->
  <section class="progress-logs">
    <h2>Warcraft Logs</h2>
    <p>Analizza fight, performance, strategie e miglioramenti del team.</p>

    <a href="https://www.warcraftlogs.com/guild/eu/nemesis/DeliriumTremens"
       target="_blank" class="apply-button">
      Apri i Logs degli Abyss Chosen
    </a>
  </section>

</main>

<footer>
<p>&copy; 2025 Delirium Tremens</p>
</footer>

<!-- ==========================
    FADE-IN / FADE-OUT SCRIPT
========================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");
});
document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function(e){
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- ==========================
      URL CLOUDFLARE WORKERS
========================== -->
<script>
const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";  
const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";  
// deve essere il dominio del worker, senza endpoint finale
// es: "https://manaforge-progress.workers.dev"
</script>

<!-- ==========================
     FETCH + CHARTJS SCRIPT
========================== -->
<script>
// ================================
// FETCH DATA per FULL progress
// ================================
async function fetchFullProgress() {
  const diffs = ["normal", "heroic", "mythic"];
  const results = {};

  for (const d of diffs) {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${d}`);
    results[d] = await res.json();
  }

  return results;
}

// ================================
// FETCH DATA per LAST SESSION
// ================================
async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

// ================================
// RENDER FULL PROGRESS
// ================================
function renderFullChart(full) {
  const bossSet = new Set();

  Object.values(full).forEach(diff => {
    if (!diff.bosses) return;
    for (const b in diff.bosses) bossSet.add(b);
  });

  const bosses = Array.from(bossSet);

  const normal = bosses.map(b => full.normal?.bosses?.[b]?.kills ? 1 : 0);
  const heroic = bosses.map(b => full.heroic?.bosses?.[b]?.kills ? 1 : 0);
  const mythic = bosses.map(b => full.mythic?.bosses?.[b]?.kills ? 1 : 0);

  new Chart(document.getElementById("fullProgressChart"), {
    type: "bar",
    data: {
      labels: bosses,
      datasets: [
        { label: "Normal", data: normal, backgroundColor: "#4CAF50" },
        { label: "Heroic", data: heroic, backgroundColor: "#FFC107" },
        { label: "Mythic", data: mythic, backgroundColor: "#E91E63" }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { max: 1, ticks: { color: "#fff" } },
        x: { ticks: { color: "#fff" } }
      },
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });
}

// ================================
// RENDER LAST SESSION
// ================================
function renderLastChart(last) {
  const bosses = Object.keys(last.bosses || {});
  const percentages = bosses.map(b => last.bosses[b].bestPercentage ?? 0);

  new Chart(document.getElementById("lastSessionChart"), {
    type: "bar",
    data: {
      labels: bosses,
      datasets: [{
        label: "Best % (0 = kill)",
        data: percentages,
        backgroundColor: "#29B6F6"
      }]
    },
    options: {
      scales: {
        y: { ticks: { color: "#fff" } },
        x: { ticks: { color: "#fff" } }
      },
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });
}

// ================================
// LOAD EVERYTHING
// ================================
(async () => {
  const full = await fetchFullProgress();
  renderFullChart(full);

  const last = await fetchLastSession();
  renderLastChart(last);
})();
</script>

</body>
</html>
