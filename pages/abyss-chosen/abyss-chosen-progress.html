<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Abyss Chosen – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

<style>
/* BASE IDENTICA A MINDBOUND PROGRESS */
body {
  background: #0b0b0b;
  color: #ccc;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

/* HEADER */
header {
  display: flex;
  justify-content: center;
  padding: 20px 0 10px;
}
.mainnav ul {
  list-style: none;
  display: flex;
  gap: 25px;
  padding: 0;
  margin: 0;
}
.mainnav a {
  color: #fff;
  text-decoration: none;
  font-size: 1.05rem;
  transition: .3s;
}
.mainnav a:hover,
.mainnav a.active {
  color: #ff5050;
  text-shadow: 0 0 8px #ff5050;
}

/* SUBNAV */
.subnav {
  margin-top: 20px;
  background: rgba(20,20,20,0.8);
  padding: 12px 0;
  text-align: center;
  border-top: 1px solid rgba(255,255,255,0.1);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(4px);
}
.subnav ul {
  display: flex;
  gap: 40px;
  justify-content: center;
  padding: 0;
  list-style: none;
}
.subnav a {
  color: #fff;
  text-decoration: none;
  transition: .3s;
}
.subnav a.active,
.subnav a:hover {
  color: #ff5050;
  text-shadow: 0 0 8px #ff5050;
}

/* HERO */
.hero {
  padding: 80px 20px 50px;
  background: none;
  text-align: center;
}
.hero h2 {
  font-size: 3rem;
  color: #fff;
  opacity: 0;
  transform: translateY(25px);
  animation: fadeUp .9s ease forwards;
}
.hero p {
  max-width: 720px;
  margin: 0 auto;
  font-size: 1.3rem;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeUp 1.3s ease forwards;
}
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

/* BACKGROUND */
.bg-container {
  position: relative;
  background: url('../../img/abysschosen_logo.png') center/cover no-repeat;
  padding: 60px 0 80px;
}
.bg-container::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(2px);
}
.bg-container > * { position: relative; z-index: 2; }

/* CONTENT */
main.panel {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 20px;
}
.section-title {
  text-align: center;
  color: #fff;
  font-size: 2rem;
  margin: 20px 0 10px;
}
.section-subtitle {
  text-align: center;
  max-width: 800px;
  margin: 0 auto 25px;
  color: #ddd;
}

/* GRID CARD IDENTICA */
.widgets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 30px;
  margin: 35px 0 10px;
}
.widget-card {
  background: rgba(15,15,15,0.8);
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.15);
  padding: 18px;
  backdrop-filter: blur(4px);
  box-shadow: 0 0 18px rgba(255,80,80,0.35);
  opacity: 0;
  animation: fadeZoom .7s ease forwards;
}
.widget-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 25px rgba(255,80,80,0.6);
  border-color: rgba(255,80,80,0.45);
}
@keyframes fadeZoom { to { opacity:1; transform:scale(1);} }

/* PROGRESS CONTENT */
.progress-content {
  background: rgba(5,5,5,0.6);
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
}

/* BOSS TAGS */
.boss-list {
  margin-top: 8px;
  font-size: 0.9rem;
  color: #ccc;
}
.boss-list span {
  margin-right: 8px;
  padding: 4px 6px;
  border-radius: 6px;
}
.boss-killed {
  color: #9fffba;
  border: 1px solid rgba(80,255,120,0.4);
}
.boss-progress {
  color: #ffeab4;
  border: 1px solid rgba(255,200,80,0.4);
}

/* TIMELINE */
.session-summary-card {
  background: rgba(15,15,15,0.85);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 0 25px rgba(255,80,80,0.4);
  border: 1px solid rgba(255,255,255,0.15);
}
.timeline-container {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 25px;
}
.timeline-card {
  background: rgba(25,25,25,0.85);
  padding: 20px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 0 20px rgba(255,80,80,0.25);
}
.timeline-card.kill {
  border-color: rgba(80,255,120,0.4);
  box-shadow: 0 0 25px rgba(80,255,120,0.4);
}
.timeline-card.progress {
  border-color: rgba(255,180,60,0.35);
  box-shadow: 0 0 25px rgba(255,180,60,0.35);
}

footer {
  text-align:center;
  padding:40px 0;
  color:#777;
}
</style>
</head>

<body class="page-transition">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<!-- SUBNAV -->
<nav class="subnav">
  <ul>
    <li><a href="abyss-chosen.html">Home Team</a></li>
    <li><a href="roster-abyss.html">Roster</a></li>
    <li><a href="abyss-news.html">News</a></li>
    <li><a href="abyss-chosen-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<div class="bg-container">
  <main class="panel">

    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Stato del progress in Normal, Heroic e Mythic del team Abyss Chosen.
    </p>

    <div class="widgets-grid">
      <div class="widget-card">
        <h3 class="widget-title">Normal</h3>
        <p class="widget-desc">Progress in Normal.</p>
        <div class="progress-content" id="card-normal">Caricamento...</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Heroic</h3>
        <p class="widget-desc">Progress in Heroic.</p>
        <div class="progress-content" id="card-heroic">Caricamento...</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Mythic</h3>
        <p class="widget-desc">Il livello più alto di progress.</p>
        <div class="progress-content" id="card-mythic">Caricamento...</div>
      </div>
    </div>

    <!-- ULTIMA SESSIONE -->
    <h2 class="section-title" id="last-session-title">Ultima sessione raid</h2>
    <p class="section-subtitle">Riepilogo di pull, wipe, kill e progress dell’ultima serata.</p>

    <div class="session-summary-card" id="last-session-summary">
      Caricamento dati dell'ultima sessione...
    </div>

    <div class="timeline-container" id="last-session-timeline"></div>

    <!-- REPORT BUTTON -->
    <div style="text-align:center; margin-top:35px;">
      <a id="last-session-report-link"
         href="#"
         target="_blank"
         class="apply-button"
         style="display:none;">
         Apri il report dell’ultima sessione
      </a>
    </div>

    <!-- LOGS GENERALI -->
    <h2 class="section-title">Warcraft Logs</h2>
    <p class="section-subtitle">
      Accedi alla pagina dei log per analisi approfondite.
    </p>
    <div style="text-align:center; margin-top: 15px;">
      <a href="https://www.warcraftlogs.com/guild/eu/nemesis/DeliriumTremens"
         target="_blank"
         class="apply-button">
        Apri i Warcraft Logs
      </a>
    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Delirium Tremens</p>
</footer>

<script>
/* TRANSIZIONE */
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");
});
document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function(e){
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(()=>{ window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- WORKERS ABYSS -->
<script>
const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";
</script>

<!-- LOGICA (identica a MindBound) -->
<script>
async function loadDifficulty(diff, id){
  const el = document.getElementById(id);
  try {
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();

    const bosses = Object.keys(data.bosses || {});
    const total = bosses.length;

    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const prog = bosses.filter(
      b => data.bosses[b].kills === 0 &&
           data.bosses[b].bestPercentage !== null &&
           data.bosses[b].bestPercentage < 100
    );

    let html = `
      <div><strong>Boss sconfitti:</strong> ${killed.length} / ${total}</div>
      <div><strong>Boss in progress:</strong> ${prog.length}</div>
    `;

    const best = prog.map(b => data.bosses[b].bestPercentage);
    html += `<div><strong>Miglior pull:</strong> ${
      best.length ? Math.min(...best) + "%" : "–"
    }</div>`;

    html += `<div class="boss-list">`;
    killed.forEach(b => html += `<span class="boss-killed">${b}</span>`);
    prog.forEach(b => html += `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`);
    html += `</div>`;

    el.innerHTML = html;

  } catch(e) {
    el.textContent = "Errore nel caricamento.";
  }
}

async function fetchLast(){
  const r = await fetch(`${WORKER_LAST}/progress-last`);
  return r.json();
}

function formatDuration(ms){
  if(!ms) return "N/D";
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  return `${h>0 ? h+"h " : ""}${m}m`;
}

function renderLast(last){
  const timeline = document.getElementById("last-session-timeline");
  const summary = document.getElementById("last-session-summary");
  const link = document.getElementById("last-session-report-link");

  const bosses = Object.values(last.bosses || {});
  if(!bosses.length){
    summary.innerHTML = "Nessun dato disponibile.";
    return;
  }

  if(last.latestReport?.code){
    link.href = `https://www.warcraftlogs.com/reports/${last.latestReport.code}`;
    link.style.display = "inline-block";
  }

  const pulls = bosses.reduce((s,b)=>s+b.pulls,0);
  const wipes = bosses.reduce((s,b)=>s+b.wipes,0);
  const kills = bosses.reduce((s,b)=>s+b.kills,0);

  summary.innerHTML = `
    <strong>Boss affrontati:</strong> ${bosses.length}<br>
    <strong>Pull totali:</strong> ${pulls}<br>
    <strong>Wipe totali:</strong> ${wipes}<br>
    <strong>Kill totali:</strong> ${kills}<br>
    <strong>Durata sessione:</strong> ${
      formatDuration(last.latestReport.endTime - last.latestReport.startTime)
    }
  `;

  bosses.sort((a,b)=>a.bossName.localeCompare(b.bossName));
  timeline.innerHTML = "";

  bosses.forEach(b=>{
    const card = document.createElement("div");
    card.className = "timeline-card " + (b.kills>0 ? "kill" : "progress");
    card.innerHTML = `
      <div class="timeline-title">${b.bossName}</div>
      <div class="timeline-info"><strong>Esito:</strong> ${b.kills>0?"Kill ✔️":"Progress"}</div>
      <div class="timeline-info"><strong>Pulls:</strong> ${b.pulls}</div>
      <div class="timeline-info"><strong>Wipes:</strong> ${b.wipes}</div>
      <div class="timeline-info"><strong>Best %:</strong> ${b.bestPercentage ?? "—"}%</div>
    `;
    timeline.appendChild(card);
  });
}

(async()=>{
  loadDifficulty("normal", "card-normal");
  loadDifficulty("heroic", "card-heroic");
  loadDifficulty("mythic", "card-mythic");

  const last = await fetchLast();
  renderLast(last);
})();
</script>

</body>
</html>
