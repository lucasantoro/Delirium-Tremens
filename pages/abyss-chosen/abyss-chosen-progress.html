<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Abyss Chosen – Progress</title>
<link rel="stylesheet" href="../../css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="page-transition abyss-bg">

<header>
  <h1>Abyss Chosen</h1>
  <nav>
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="../abyss-chosen/abyss-chosen.html">Home Team</a></li>
    <li><a href="../abyss-chosen/roster-abyss.html">Roster</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-news.html">News</a></li>
    <li><a href="../abyss-chosen/abyss-chosen-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<main class="panel progress-panel">

  <!-- ==========================
        RAID ATTUALE
  =========================== -->
  <section class="current-progress">
    <h2 id="raidTitle">Caricamento raid...</h2>

    <div class="chart-wrapper">
      <button class="chart-nav prev" type="button">◀</button>
      <canvas id="progressChart" width="400" height="220"></canvas>
      <button class="chart-nav next" type="button">▶</button>
    </div>

    <p id="raidSummary" class="raid-summary"></p>
  </section>

  <!-- ==========================
        WARCRAFT LOGS
  =========================== -->
  <section class="progress-logs">
    <h2>Warcraft Logs</h2>
    <p>Analizza fight, performance, strategie e miglioramenti del team.</p>

    <a href="https://www.warcraftlogs.com/guild/eu/nemesis/DeliriumTremens"
       target="_blank" class="apply-button">
      Apri i Logs degli Abyss Chosen
    </a>
  </section>

</main>

<footer>
<p>&copy; 2025 Delirium Tremens</p>
</footer>

<!-- ==========================
    FADE-IN / FADE-OUT SCRIPT
========================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");
});
document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", function(e){
      e.preventDefault();
      const href = this.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});
</script>

<!-- ==========================
      URL CLOUDFLARE WORKER
========================== -->
<script>
// Sostituisci qui con IL TUO WORKER:
const WCL_PROXY = "https://red-snowflake-a386.workers.dev/progress";
</script>

<!-- ==========================
     FETCH RAID + CHART
========================== -->
<script>
async function loadWCLProgress() {
  const res = await fetch(WCL_PROXY);
  const json = await res.json();

  const zones = json.data.guildData.guild.expansion.zones;

  // Filtra solo i raid con progress reale
  return zones
    .filter(z => z.difficulties && z.difficulties.some(d => d.status.total > 0))
    .map(z => ({
      name: z.name,
      difficulties: z.difficulties.map(d => ({
        diff: d.difficulty,
        killed: d.status.killed,
        total: d.status.total
      }))
    }));
}

let chart;
let currentRaid = 0;
let raids = [];

function createChart(raid) {
  const ctx = document.getElementById("progressChart").getContext("2d");

  const normal = raid.difficulties.find(d => d.diff === "Normal")?.killed ?? 0;
  const heroic = raid.difficulties.find(d => d.diff === "Heroic")?.killed ?? 0;
  const mythic = raid.difficulties.find(d => d.diff === "Mythic")?.killed ?? 0;
  const total = raid.difficulties[0].total;

  document.getElementById("raidTitle").textContent = raid.name;
  document.getElementById("raidSummary").textContent =
    `${normal}/${total} N • ${heroic}/${total} HC • ${mythic}/${total} M`;

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Normal", "Heroic", "Mythic"],
      datasets: [{
        label: "Boss uccisi",
        data: [normal, heroic, mythic],
        backgroundColor: [
          "rgba(120, 80, 200, 0.8)",
          "rgba(160, 60, 220, 0.8)",
          "rgba(200, 40, 140, 0.8)"
        ],
        borderWidth: 2,
        borderRadius: 6
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: "#e6d6ff", stepSize: 1 }
        },
        x: {
          ticks: { color: "#e6d6ff" }
        }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function nextRaid() {
  currentRaid = (currentRaid + 1) % raids.length;
  createChart(raids[currentRaid]);
}
function prevRaid() {
  currentRaid = (currentRaid - 1 + raids.length) % raids.length;
  createChart(raids[currentRaid]);
}

window.addEventListener("DOMContentLoaded", async () => {
  raids = await loadWCLProgress();
  createChart(raids[0]);

  document.querySelector(".chart-nav.next").onclick = nextRaid;
  document.querySelector(".chart-nav.prev").onclick = prevRaid;
});
</script>

</body>
</html>
